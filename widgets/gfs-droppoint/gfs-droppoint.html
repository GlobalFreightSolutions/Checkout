<link rel="import" href="../../polymer/polymer.html" />

<dom-module id="gfs-droppoint">

    <template>
        <style>
            .dp-heading {
                font-size: 12px;
                clear: left;
                margin-bottom: 3px;
            }

            .label
            {
                color:white;
                font-weight:bold;
            }

            .content
            {
                width:100%;
            }
            .dp-address
            {
                text-align:left;
            }

            .opening-hours
            {
                font-size: 14px;
            }

            .choose-droppoint
            {
                background-color: #555555;
                border: none;
                color: white;
                padding: 15px 32px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 16px;
            }

            .choose-droppoint.chosen {
                 background-color: #4CAF50; /* Green */
            }

            div.day-name {
                color: white;
                float: left;
            }

            div.day-time-slot {

            }

        </style>

            <div class="dp-icon">
                <img src="{{droppointData.providerLogo}}" class="imageicon" width="45" height="45"></img>
            </div>
            <div class="dp-heading">{{droppointData.providerName}}</div>
            <div id="dp-address">
                <template is="dom-repeat" items="{{droppointData.geoLocation.addressLines}}">
                    {{item}}
                    <br />
                </template>
                {{droppointData.geoLocation.town}}, {{droppointData.geoLocation.postCode}}
            </div>
            <br />
        
            <div class="opening-hours">
                <span class="dp-heading">Opening Hours</span>:
                <template is="dom-repeat" items="{{droppointData.collectionSlots}}">
                    <div class="day-name">{{item.day}}</div>
                    <template is="dom-repeat" items={{item.timeSlots}}>
                        <div class="day-time-slot">{{item.fromTime}} - {{item.toTime}}</div>
                    </template>
                </template>
 
                <button on-click="toggleChooseDropPoint" class$="button choose-droppoint {{buttonClass}}">{{buttonText}}</button>
            </div>
    </template>

    <script>

        Polymer({
            is: "gfs-droppoint",

            properties: {
                droppointData: {
                    type: Object,
                    value: {}
                },
                chosen: {
                    type: Boolean,
                    value: false,
                    notify: true
                },
                droppointId: {
                    type: String                
                },
                buttonClass: {
                    type: String,
                    value: "unchosen"
                },
                buttonText: {
                    type: String,
                    value: "Choose"
                }
            },
            listeners: {
                'chosen-changed': 'chosenChanged',
                //'droppointChosen': 'otherChosenChanged'
               // 'chosenChanged': 'chosenChanged2'
            },

            chosenChanged: function (e) {
                console.log('chosenChanged', e);
                if (this.chosen) {
                    this.fire("droppointChosen", this, true);
                }
                if (this.chosen) {
                    this.buttonClass = "chosen";
                    this.buttonText = "Chosen";
                }
                else {
                    this.buttonClass = "unchosen";
                    this.buttonText = "Choose";
                }
            },

            otherChosenChanged: function(e) {
                
                //If I am chosen, and the other droppoint has been chosen, unchoose me
                if (this.chosen && (e.detail.chosen == true) && (e.detail.droppointId !== this.droppointId)) {
                    console.log('otherChosenChanged', e);
                    this.chosen = false;
                    debugger;
                }
            },


            ready: function()
            {
                console.log(this.droppointData);

                var dayCount = 0;
                var self = this;
                this.chosen = this.droppointData.chosen;
                this.droppointId = this.droppointData.droppointId;

                //window.addEventListener('droppointChosen', this.otherChosenChanged.bind(this), false);


                if (this.droppointData && this.droppointData.collectionSlots) {
                    this.droppointData.distanceInKm = (Math.round(this.droppointData.DistanceInMeters / 100)) / 10;

                    this.droppointData.collectionSlots.forEach(function (collectionSlot) {
                        dayCount++;
                        if (dayCount <= 7) {

                            collectionSlot.collectionDateTime = self._getUtcTime(new Date(collectionSlot.collectionDate));
                            collectionSlot.day = DOW_NAMES[collectionSlot.collectionDateTime.getDay()];

                            collectionSlot.timeSlots.forEach(function (timeSlot) {
                                timeSlot.fromDateTime = self._getUtcTime(new Date(timeSlot.from));
                                timeSlot.toDateTime = self._getUtcTime(new Date(timeSlot.to));
                                timeSlot.fromTime = self._getTimeStr(timeSlot.fromDateTime);
                                timeSlot.toTime = self._getTimeStr(timeSlot.toDateTime);
                            });
                        }
                    });
                }
            },

            toggleChooseDropPoint: function()
            {
                //this.droppointData.chosen = !this.droppointData.chosen;
                this.chosen = !this.chosen; //this.droppointData.chosen;
            },

            _getUtcTime: function (d) {
                var utc = new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate(), d.getUTCHours(), d.getUTCMinutes(), d.getUTCSeconds());
                return utc;
            },

            _getTimeStr: function (d) {
                var minutes = d.getMinutes().toString().length == 1 ? '0' + d.getMinutes() : d.getMinutes();
                var hours = (d.getHours() % 12).toString();
                var ampm = d.getHours() >= 12 ? 'pm' : 'am';
                return hours + ':' + minutes + ampm;
            },

            _listenForChoose: function (e) {

            }

        });
    </script>
</dom-module>